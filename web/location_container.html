<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
  </head>
  <body>
    <element name="location-container">
      <template>
        <div class="location_management_container">
          <span class="location-results-label">Results: {{unselectedLocations.length}} {{locationLabel}} found</span>
          <div class="location-results-operations">
            <!-- TODO add 'sort' and 'add all' buttons here -->
          </div>
          <div class="location-results" id="location-results">
            <template instantiate="if !unselectedLocations.isEmpty">
              <ul id="location-list">
                <template iterate="location in unselectedLocations" >
                  <li on-double-click="changeSelection(location)" draggable="true" on-drag-start="dragLocation(location)">
                    <span class="location-name">{{location.name}}</span>      
                    <span class="location-address">{{location.address}}</span>                   
                  </li>
                </template>
              </ul>        
            </template>
            <template instantiate="if unselectedLocations.isEmpty">
              <span class="empty">No locations found</span>      
            </template>
          </div>
        </div>
        
        <div class="location_management_container" on-drop="changeLocationSelection()" on-drag-over="dropUnselectedLocation($event)">
          <span class="location-results-label">Selected Locations: {{selectedLocations.length}}</span>
          <div class="location-results-operations">
            <!-- TODO add 'sort' and 'add all' buttons here -->
          </div>
          <div class="location-results">
            <template instantiate="if !selectedLocations.isEmpty">
              <ul id="location-list">
                <template iterate="location in selectedLocations" >
                  <li on-double-click="changeSelection(location)">
                    <span class="location-name">{{location.name}}</span>      
                    <span class="location-address">{{location.address}}</span>                   
                  </li>
                </template>
              </ul>        
            </template>
            <template instantiate="if selectedLocations.isEmpty">
              <span class="empty">No locations selected</span>      
            </template>
          </div>
        </div>
      </template>
      
      <script type="application/dart">
        import 'dart:async';
        import 'dart:html' as HTML;
        import 'package:web_ui/web_ui.dart';
        import 'package:dart_prototype/dart_prototype_library.dart';
   
        class LocationContainer extends WebComponent {
          
          @observable
          WebService locationService;
  
          @observable
          final ObservableList<Location> locations = new ObservableList<Location>();
       
          LocationContainer() {  
          }            
      
          void inserted() {
            refreshLocations();
            
            HTML.Element e = document.query('#location-results');
            e.onScroll.listen((event) => getMoreLocations(e));
          }
      
          void refreshLocations() {
            locationService.call("/locations").then((response) {
                locations.addAll(response);
            });
          }
          
          void getMoreLocations(HTML.Element e) {
            double percentage = (e.scrollTop + e.offsetHeight) / e.scrollHeight;
            if (percentage > .99) {
              refreshLocations();
            }
          }
 
          void changeSelection(Location selectedLocation) {
            selectedLocation.selected = !selectedLocation.selected;
          }
          
          
          Location draggedLocation;
          void dragLocation(Location selectedLocation) {
            print('dragging ' + selectedLocation.name);
            draggedLocation = selectedLocation;
          }

          void dropUnselectedLocation(HTML.Event e) {
             e.preventDefault();
          }
          
          void changeLocationSelection() {
             changeSelection(draggedLocation);
          }
          
          @observable
          List get selectedLocations {
            return locations.where((loc) => loc.selected).toList();
          }
 
          @observable
          List get unselectedLocations {
            return locations.where((loc) => !loc.selected).toList();
          }

          @observable // this isn;t working properly. List.length is not an observable property I guess... not sure
          String get locationLabel {
            if (selectedLocations.length == 1) {
              return "Location";
            } else {
              return "Locations";
            }
          }
        }        
      </script>
    </element>
  </body>
</html>
