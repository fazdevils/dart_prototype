<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
  </head>
  <body>
    <element name="location-container">
      <template>
        <div>
          <span class="location-results-label">Results: {{locations.length}} {{locationLabel}} found</span>
          <div class="location-results-operations">
            <!-- TODO add 'sort' and 'add all' buttons here -->
          </div>
          <div class="location-results">
            <template instantiate="if locations.length > 0">
              <ul id="location-list">
                <template iterate="location in locations" >
                  <li>
                    <span class="location-name">{{location.name}}</span>      
                    <span class="location-address">{{location.address}}</span>                   
                  </li>
                </template>
              </ul>        
            </template>
            <template instantiate="if empty">
              <span class="empty">No locations found</span>      
            </template>
          </div>
        </div>
      </template>
      <script type="application/dart">
        import 'dart:async';
        import 'dart:html' as HTML;
        import 'package:web_ui/web_ui.dart';
        import 'package:dart_prototype/dart_prototype_library.dart';
   
        class LocationContainer extends WebComponent {
          
          @observable
          WebService locationService;
  
          @observable
          final ObservableList<Location> locations = new ObservableList<Location>();
       
          LocationContainer() {  
          }            
      
          void inserted() {
            refreshLocations();
            Duration duration = new Duration(seconds: 5);
            
            HTML.Element e = document.query('.location-results');
            e.onScroll.listen((event) => getMoreLocations(e));
          }
      
          void refreshLocations() {
            locationService.call("/locations").then((response) {
                locations.addAll(response);
                print(locations.length);
            });
          }
          
          void getMoreLocations(HTML.Element e) {
            double percentage = (e.scrollTop + e.offsetHeight) / e.scrollHeight;
            if (percentage > .99) {
              print("getting more locations");
              refreshLocations();
            }
          }
 
          @observable
          bool get empty {
            return locations.isEmpty;
          }

          @observable
          String get locationLabel {
            if (locations.length == 1) {
              return "Location";
            } else {
              return "Locations";
            }
          }
        }        
      </script>
    </element>
  </body>
</html>
